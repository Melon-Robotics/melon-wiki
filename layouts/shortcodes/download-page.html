{{/* Generic page-content PDF download button.
     Usage: {{< download-page >}}  or  {{< download-page "Custom label" >}}
     Strips interactive widgets (.ndl-lookup, .dlf-wrap) before printing. */}}
{{- $label := .Get 0 | default "Download as PDF" -}}
<div class="pdf-dl-bar" id="pdf-dl-bar-{{ .Ordinal }}">
  <button class="pdf-dl-btn" id="pdf-dl-btn-{{ .Ordinal }}">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
    {{ $label }}
  </button>
  <span class="pdf-dl-hint">Opens print dialog â€” choose "Save as PDF" to download</span>
</div>

<script>
(function() {
  var btn = document.getElementById('pdf-dl-btn-{{ .Ordinal }}');
  if (!btn) return;

  btn.addEventListener('click', function() {
    var contentEl = document.querySelector('.post-content');
    if (!contentEl) { window.print(); return; }

    // Deep-clone so mutations don't affect the live page
    var clone = contentEl.cloneNode(true);

    // Remove interactive / non-printable elements
    ['.ndl-lookup', '.dlf-wrap', '.pdf-dl-bar'].forEach(function(sel) {
      clone.querySelectorAll(sel).forEach(function(el) { el.remove(); });
    });

    // Page title from the post header
    var titleEl = document.querySelector('.post-title') || document.querySelector('h1');
    var pageTitle = titleEl ? titleEl.textContent.trim() : document.title;
    var safeTitle = pageTitle.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

    var printDoc = [
      '<!DOCTYPE html>',
      '<html>',
      '<head>',
      '<meta charset="utf-8">',
      '<title>' + safeTitle + '</title>',
      '<style>',
      '  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }',
      '  body {',
      '    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;',
      '    font-size: 0.775rem;',
      '    line-height: 1.5;',
      '    color: #111;',
      '    background: #fff;',
      '    padding: 16px 20px;',
      '  }',
      '  .print-title-block {',
      '    margin-bottom: 16px;',
      '    padding-bottom: 10px;',
      '    border-bottom: 2px solid #111;',
      '  }',
      '  .print-title-block h1 { font-size: 1.25rem; font-weight: 700; }',
      '  h2 {',
      '    font-size: 1rem;',
      '    font-weight: 700;',
      '    margin: 18px 0 8px 0;',
      '    padding-top: 12px;',
      '    border-top: 1px solid #ccc;',
      '  }',
      '  h2:first-of-type { border-top: none; padding-top: 0; margin-top: 0; }',
      '  h3 { font-size: 0.875rem; font-weight: 700; margin: 12px 0 6px 0; }',
      '  h4 {',
      '    font-size: 0.7rem;',
      '    font-weight: 700;',
      '    margin: 8px 0 4px 0;',
      '    text-transform: uppercase;',
      '    letter-spacing: 0.04em;',
      '  }',
      '  p  { margin: 0 0 8px 0; }',
      '  ul, ol { margin: 0 0 8px 0; padding-left: 18px; }',
      '  li { margin: 2px 0; }',
      '  hr { border: none; border-top: 1px solid #ddd; margin: 10px 0; }',
      '  strong { font-weight: 700; }',
      '  em { font-style: italic; }',
      '  code {',
      '    font-family: monospace;',
      '    font-size: 0.7rem;',
      '    background: #f5f5f5;',
      '    padding: 1px 3px;',
      '  }',
      '  blockquote {',
      '    border-left: 3px solid #c00;',
      '    background: #fff5f5;',
      '    padding: 8px 12px;',
      '    margin: 8px 0 12px 0;',
      '    -webkit-print-color-adjust: exact;',
      '    print-color-adjust: exact;',
      '  }',
      '  blockquote p { margin: 0; line-height: 1.5; }',
      '  table {',
      '    width: 100%;',
      '    border-collapse: collapse;',
      '    margin: 6px 0 14px 0;',
      '    font-size: 0.7rem;',
      '  }',
      '  th, td {',
      '    border: 1px solid #bbb;',
      '    padding: 3px 6px;',
      '    text-align: left;',
      '    vertical-align: top;',
      '  }',
      '  th {',
      '    background: #eee;',
      '    font-weight: 700;',
      '    -webkit-print-color-adjust: exact;',
      '    print-color-adjust: exact;',
      '  }',
      '  /* Hide anchored heading links */',
      '  .anchor, a[href^="#"]:has(svg) { display: none !important; }',
      '  @media print {',
      '    body { padding: 4px; font-size: 0.7rem; }',
      '    h2 { page-break-after: avoid; margin-top: 14px; }',
      '    h3 { page-break-after: avoid; }',
      '    table { page-break-inside: avoid; }',
      '    blockquote { page-break-inside: avoid; }',
      '  }',
      '</style>',
      '</head>',
      '<body>',
      '<div class="print-title-block"><h1>' + safeTitle + '</h1></div>',
      clone.innerHTML,
      '</body>',
      '</html>'
    ].join('\n');

    var win = window.open('', '_blank', 'width=1050,height=800,scrollbars=yes');
    if (!win) { window.print(); return; }

    win.document.open();
    win.document.write(printDoc);
    win.document.close();

    win.setTimeout(function() {
      win.focus();
      win.print();
    }, 500);
  });
})();
</script>
